name: Redirect pull requests to test

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize

permissions:
  contents: write
  pull-requests: write

jobs:
  redirect-and-merge:
    name: Ensure test branch and merge PR
    runs-on: ubuntu-latest
    steps:
      - name: Ensure test branch exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          if git ls-remote --exit-code "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git" test >/dev/null 2>&1; then
            echo "Branch 'test' already exists."
            exit 0
          fi

          echo "Creating branch 'test' from '${DEFAULT_BRANCH}'."
          DEFAULT_REF_RESPONSE=$(curl -sSf -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${REPO}/git/refs/heads/${DEFAULT_BRANCH}")
          DEFAULT_SHA=$(echo "${DEFAULT_REF_RESPONSE}" | jq -r '.object.sha')
          if [ -z "${DEFAULT_SHA}" ] || [ "${DEFAULT_SHA}" = "null" ]; then
            echo "Unable to determine SHA for ${DEFAULT_BRANCH}." >&2
            exit 1
          fi

          CREATE_RESPONSE=$(curl -sS -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${REPO}/git/refs" -d "{\"ref\":\"refs/heads/test\",\"sha\":\"${DEFAULT_SHA}\"}")
          if echo "${CREATE_RESPONSE}" | jq -e '.ref' >/dev/null 2>&1; then
            echo "Branch 'test' created successfully."
          else
            echo "Failed to create 'test' branch: ${CREATE_RESPONSE}" >&2
            exit 1
          fi

      - name: Determine if author is trusted
        id: author-trust
        env:
          AUTHOR_ASSOCIATION: ${{ github.event.pull_request.author_association }}
        run: |
          set -euo pipefail
          case "${AUTHOR_ASSOCIATION}" in
            OWNER|MEMBER|COLLABORATOR)
              echo "Author is trusted (${AUTHOR_ASSOCIATION})."
              echo "trusted=true" >>"${GITHUB_OUTPUT}"
              ;;
            *)
              echo "Author is not in the trusted allowlist (${AUTHOR_ASSOCIATION})."
              echo "trusted=false" >>"${GITHUB_OUTPUT}"
              ;;
          esac

      - name: Retarget pull request to test
        if: steps.author-trust.outputs.trusted == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.url }}
          CURRENT_BASE: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail
          if [ "${CURRENT_BASE}" = "test" ]; then
            echo "Pull request already targets 'test'."
            exit 0
          fi

          RESPONSE=$(curl -sS -X PATCH -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "${PR_URL}" -d '{"base":"test"}')
          if echo "${RESPONSE}" | jq -e '.base.ref == "test"' >/dev/null 2>&1; then
            echo "Pull request retargeted to 'test'."
          else
            echo "Failed to retarget pull request: ${RESPONSE}" >&2
            exit 1
          fi

      - name: Merge pull request into test
        if: steps.author-trust.outputs.trusted == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          MERGE_URL="https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}/merge"
          RESPONSE=$(curl -sS -X PUT -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "${MERGE_URL}" -d '{"merge_method":"merge"}')
          if echo "${RESPONSE}" | jq -e '.merged == true' >/dev/null 2>&1; then
            echo "Pull request merged successfully."
          else
            echo "Merge attempt did not succeed: ${RESPONSE}" >&2
            exit 1
          fi

      - name: Halt for untrusted authors
        if: steps.author-trust.outputs.trusted != 'true'
        run: |
          echo "Skipping retargeting and merging for untrusted contributor."
